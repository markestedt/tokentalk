name: Build and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  create-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.get_version.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: get_version
        run: |
          # Get latest tag or default to v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # Increment patch version
          NEW_VERSION=$(echo $LATEST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

  build-windows:
    runs-on: windows-latest
    needs: create-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.7'

      - name: Install dependencies
        run: go mod download

      - name: Build Windows executable
        run: go build -ldflags "-s -w" -o tokentalk-windows-amd64.exe .
        env:
          CGO_ENABLED: 0

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tokentalk-windows-amd64
          path: tokentalk-windows-amd64.exe

  create-release:
    runs-on: ubuntu-latest
    needs: [create-version, build-windows]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-version.outputs.new_version }}
          name: Release ${{ needs.create-version.outputs.new_version }}
          body: |
            Automated release from commit ${{ github.sha }}

            Changes in this release:
            ${{ github.event.head_commit.message }}

            ## Installation
            Download `tokentalk-windows-amd64.exe`, rename to `tokentalk.exe`, and run.
          files: |
            tokentalk-windows-amd64/tokentalk-windows-amd64.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
